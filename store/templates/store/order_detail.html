{% extends 'base.html' %}
<!-- DEBUG_MARKER_CHECK_PERSISTENCE -->
{% block title %}Order #{{ order.id }} Details{% endblock %}

{% block content %}
<style>
    /* Custom Styles for Order Status Tracker */
    .status-container {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }

    .tracker-header {
        font-size: 1.25rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 3rem;
    }

    .progress-track {
        position: relative;
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }

    /* Background Line */
    .progress-line-bg {
        position: absolute;
        top: 50%;
        left: 0;
        width: 100%;
        height: 4px;
        background-color: #e5e7eb;
        transform: translateY(-50%);
        z-index: 1;
    }

    /* Active Line */
    .progress-line-active {
        position: absolute;
        top: 50%;
        left: 0;
        height: 4px;
        background-color: #10b981;
        /* Green */
        transform: translateY(-50%);
        z-index: 2;
        transition: width 1s ease-in-out;
        width: 0%;
    }

    .step-item {
        position: relative;
        z-index: 10;
        display: flex;
        flex-direction: column;
        align-items: center;
        background: white;
        padding: 0 10px;
    }

    .step-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #d1d5db;
        /* Gray-300 */
        background-color: white;
        color: #9ca3af;
        /* Gray-400 */
        font-weight: bold;
        transition: all 0.5s ease;
    }

    .step-icon svg {
        width: 20px;
        height: 20px;
        display: none;
        /* Hidden by default */
    }

    /* Completed State */
    .step-icon.completed {
        background-color: #10b981;
        border-color: #10b981;
        color: white;
    }

    .step-icon.completed svg {
        display: block;
    }

    .step-icon.completed span {
        display: none;
    }

    /* Active/Current State (visual only, mostly same as completed for now) */
    .step-icon.active {
        border-color: #10b981;
        color: #10b981;
    }

    .step-label {
        margin-top: 0.75rem;
        font-size: 0.875rem;
        font-weight: 600;
        color: #1f2937;
    }

    .step-time {
        margin-top: 0.25rem;
        font-size: 0.75rem;
        color: #6b7280;
    }

    /* Map Section */
    .map-container {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }

    #tracking-map {
        height: 350px;
        border-radius: 8px;
        border: 2px solid #e5e7eb;
        z-index: 1;
    }

    /* Items Section */
    .items-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .items-header {
        padding: 1rem 1.5rem;
        background-color: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .items-list {
        list-style: none;
        padding: 0;
        /* Reset default ul padding */
        margin: 0;
    }

    .item-row {
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #e5e7eb;
    }

    .item-row:last-child {
        border-bottom: none;
    }

    .item-info {
        display: flex;
        align-items: center;
    }

    .item-img {
        width: 64px;
        height: 64px;
        object-fit: cover;
        border-radius: 6px;
        margin-right: 1rem;
        border: 1px solid #e5e7eb;
    }

    .item-placeholder {
        width: 64px;
        height: 64px;
        background-color: #f3f4f6;
        border-radius: 6px;
        margin-right: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #9ca3af;
        font-size: 0.8rem;
    }

    .nav-back {
        display: inline-block;
        margin-bottom: 1rem;
        color: #4f46e5;
        text-decoration: none;
        font-weight: 500;
    }

    .nav-back:hover {
        color: #3730a3;
    }

    .truck-icon {
        /* inherited from JS divIcon style, ensuring visibility */
    }
</style>

<div class="max-w-4xl mx-auto py-8">
    <div class="mb-6 flex items-center justify-between"
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h1 style="font-size: 2rem; font-weight: bold; color: #1f2937; margin: 0;">Order #{{ order.id }}</h1>
        <a href="{% url 'order_history' %}" class="nav-back">&larr; Back to History</a>
    </div>

    <!-- Status Tracker -->
    <div class="status-container">
        <h2 class="tracker-header">Order Status</h2>

        <div class="progress-track">
            <!-- Lines -->
            <div class="progress-line-bg"></div>
            <div class="progress-line-active" id="progress-line"></div>

            <!-- Step 1: Created -->
            <div class="step-item">
                <div id="step-created-icon" class="step-icon completed">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <div class="step-label">Created</div>
                <div class="step-time local-time" id="time-created" data-timestamp="{{ order.created_at|date:'c' }}">
                </div>
            </div>

            <!-- Step 2: Shipped -->
            <div class="step-item">
                <div id="step-shipped-icon" class="step-icon {% if order.shipped_at %}completed{% endif %}">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span>2</span>
                </div>
                <div class="step-label">Shipped</div>
                <div class="step-time local-time" id="time-shipped" data-timestamp="{{ order.shipped_at|date:'c' }}">
                </div>
            </div>

            <!-- Step 3: Delivered -->
            <div class="step-item">
                <div id="step-delivered-icon" class="step-icon {% if order.delivered_at %}completed{% endif %}">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span>3</span>
                </div>
                <div class="step-label">Delivered</div>
                <div class="step-time local-time" id="time-delivered"
                    data-timestamp="{{ order.delivered_at|date:'c' }}"></div>
            </div>
        </div>
    </div>

    <!-- Tracking Map -->
    <div class="map-container">
        <h2 class="tracker-header" style="margin-bottom: 1rem;">Live Tracking Simulation</h2>
        <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">Visualizing package journey from
            Distribution Center to Customer Zone.</p>
        <div id="tracking-map"></div>
    </div>

    <!-- Order Items -->
    <div class="items-container">
        <div class="items-header">
            <h2 style="font-size: 1.125rem; font-weight: 600; color: #374151; margin:0;">Items Ordered</h2>
            <span style="font-weight: 500; color: #4b5563;">Total: ${{ order.total_price }}</span>
        </div>
        <ul class="items-list">
            {% for item in order.items.all %}
            <li class="item-row">
                <div class="item-info">
                    {% if item.product.image_url %}
                    <img src="{{ item.product.image_url }}" alt="{{ item.product.name }}" class="item-img">
                    {% else %}
                    <div class="item-placeholder">No Img</div>
                    {% endif %}
                    <div>
                        <h3 style="font-size: 1.125rem; font-weight: 500; color: #111827; margin: 0 0 0.25rem 0;">
                            {{ item.product.name }}
                        </h3>
                        <p style="color: #6b7280; font-size: 0.875rem; margin: 0;">Qty: {{ item.quantity }}</p>
                    </div>
                </div>
                <div style="text-align: right;">
                    <p style="font-weight: 500; color: #1f2937; margin:0;">${{ item.price }}</p>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const orderId = "{{ order.id }}";
        const factoryCoords = [40.7128, -74.0060];
        const destCoords = [42.3601, -71.0589];

        // Map Init
        var map = L.map('tracking-map').setView(factoryCoords, 6);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        var factoryMarker = L.marker(factoryCoords).addTo(map).bindPopup('Distribution Center');
        var destMarker = L.marker(destCoords).addTo(map).bindPopup('Delivery Address');
        var truckIcon = L.divIcon({
            className: 'truck-icon',
            html: '<div style="background-color: #10b981; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.3);"></div>',
            iconSize: [16, 16]
        });

        let truckMarker = null;

        var latlngs = [factoryCoords, destCoords];
        var polyline = L.polyline(latlngs, { color: '#3b82f6', opacity: 0.5, dashArray: '10, 10' }).addTo(map);
        map.fitBounds(polyline.getBounds(), { padding: [50, 50] });

        function formatTime(isoString) {
            if (!isoString || isoString === 'None') return 'Pending';
            const date = new Date(isoString);
            return date.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
        }

        function updateUI(data) {
            // Update Timestamps
            const createdText = formatTime(document.getElementById('time-created').getAttribute('data-timestamp'));
            document.getElementById('time-created').textContent = createdText;

            const shippedEl = document.getElementById('time-shipped');
            shippedEl.textContent = formatTime(data.shipped_at);

            const deliveredEl = document.getElementById('time-delivered');
            deliveredEl.textContent = formatTime(data.delivered_at);

            // Update Progress Line
            const progressLine = document.getElementById('progress-line');
            if (data.status === 'Created') progressLine.style.width = '0%';
            else if (data.status === 'Shipped') progressLine.style.width = '50%';
            else if (data.status === 'Delivered') progressLine.style.width = '100%';

            // Update Icons via Class Toggling
            const shippedIcon = document.getElementById('step-shipped-icon');
            if (data.is_shipped) {
                shippedIcon.classList.add('completed');
            } else {
                shippedIcon.classList.remove('completed');
            }

            const deliveredIcon = document.getElementById('step-delivered-icon');
            if (data.is_delivered) {
                deliveredIcon.classList.add('completed');
            } else {
                deliveredIcon.classList.remove('completed');
            }

            // Update Map
            let currentCoords = factoryCoords;
            if (data.status === 'Shipped') {
                currentCoords = [(factoryCoords[0] + destCoords[0]) / 2, (factoryCoords[1] + destCoords[1]) / 2];
            } else if (data.status === 'Delivered') {
                currentCoords = destCoords;
            }

            if (data.status !== 'Created') {
                if (truckMarker) {
                    truckMarker.setLatLng(currentCoords);
                } else {
                    truckMarker = L.marker(currentCoords, { icon: truckIcon }).addTo(map).bindPopup('On the way!');
                }
                if (data.status === 'Delivered') truckMarker.bindPopup('Delivered!');
            }
        }

        // Poll API
        async function fetchStatus() {
            try {
                const response = await fetch(`/api/order/${orderId}/status/`);
                const data = await response.json();
                updateUI(data);
            } catch (e) {
                console.error("Error polling status:", e);
            }
        }

        // Initial Load
        const initialData = {
            status: "{{ order.status }}",
            shipped_at: "{{ order.shipped_at|date:'c' }}",
            delivered_at: "{{ order.delivered_at|date:'c' }}",
            is_shipped: {% if order.shipped_at %}true{% else %} false{% endif %},
        is_delivered: {% if order.delivered_at %} true{% else %} false{% endif %}
    };
    updateUI(initialData);

    // Start Polling
    if (initialData.status !== 'Delivered') {
        setInterval(fetchStatus, 3000);
    }
    });
</script>
{% endblock %}