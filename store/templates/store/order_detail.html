{% extends 'base.html' %}

{% block title %}Order #{{ order.id }} Details{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto py-8">
    <div class="mb-6 flex items-center justify-between">
        <h1 class="text-3xl font-bold text-gray-800">Order #{{ order.id }}</h1>
        <a href="{% url 'order_history' %}" class="text-indigo-600 hover:text-indigo-800 font-medium">&larr; Back to
            History</a>
    </div>

    <!-- Status Tracker -->
    <div class="bg-white rounded-lg shadow-md p-8 mb-8" id="status-container">
        <h2 class="text-xl font-semibold mb-8 text-gray-700">Order Status</h2>

        <!-- Stepper Progress Bar -->
        <div class="relative flex items-center justify-between w-full">
            <div class="absolute left-0 top-1/2 transform -translate-y-1/2 w-full h-1 bg-gray-200 -z-10"></div>
            <div class="absolute left-0 top-1/2 transform -translate-y-1/2 h-1 bg-green-500 -z-10 transition-all duration-1000"
                id="progress-line" style="width: 0%;"></div>

            <!-- Step 1: Created -->
            <div class="flex flex-col items-center bg-white px-2">
                <div id="step-created-icon"
                    class="w-8 h-8 rounded-full flex items-center justify-center border-2 transition-colors duration-500 bg-green-500 border-green-500 text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <div class="mt-2 text-sm font-semibold text-gray-800">Created</div>
                <div class="text-xs text-gray-500 mt-1 local-time" id="time-created"
                    data-timestamp="{{ order.created_at|date:'c' }}"></div>
            </div>

            <!-- Step 2: Shipped -->
            <div class="flex flex-col items-center bg-white px-2">
                <div id="step-shipped-icon"
                    class="w-8 h-8 rounded-full flex items-center justify-center border-2 transition-colors duration-500 {% if order.shipped_at %}bg-green-500 border-green-500 text-white{% else %}bg-white border-gray-300 text-gray-400{% endif %}">
                    {% if order.shipped_at %}
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    {% else %}
                    2
                    {% endif %}
                </div>
                <div class="mt-2 text-sm font-semibold text-gray-800">Shipped</div>
                <div class="text-xs text-gray-500 mt-1 local-time" id="time-shipped"
                    data-timestamp="{{ order.shipped_at|date:'c' }}"></div>
            </div>

            <!-- Step 3: Delivered -->
            <div class="flex flex-col items-center bg-white px-2">
                <div id="step-delivered-icon"
                    class="w-8 h-8 rounded-full flex items-center justify-center border-2 transition-colors duration-500 {% if order.delivered_at %}bg-green-500 border-green-500 text-white{% else %}bg-white border-gray-300 text-gray-400{% endif %}">
                    {% if order.delivered_at %}
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    {% else %}
                    3
                    {% endif %}
                </div>
                <div class="mt-2 text-sm font-semibold text-gray-800">Delivered</div>
                <div class="text-xs text-gray-500 mt-1 local-time" id="time-delivered"
                    data-timestamp="{{ order.delivered_at|date:'c' }}"></div>
            </div>
        </div>
    </div>

    <!-- Tracking Map -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">Live Tracking Simulation</h2>
        <p class="text-sm text-gray-500 mb-4">Visualizing package journey from Distribution Center to Customer Zone.</p>
        <div id="tracking-map" style="height: 350px; border-radius: 8px; z-index: 1; border: 2px solid #e5e7eb;"></div>
    </div>

    <!-- Order Items -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
            <h2 class="text-lg font-semibold text-gray-700">Items Ordered</h2>
            <span class="text-gray-600 font-medium">Total: ${{ order.total_price }}</span>
        </div>
        <ul class="divide-y divide-gray-200">
            {% for item in order.items.all %}
            <li class="px-6 py-4 flex items-center justify-between">
                <div class="flex items-center">
                    {% if item.product.image_url %}
                    <img src="{{ item.product.image_url }}" alt="{{ item.product.name }}"
                        class="w-16 h-16 object-cover rounded-md mr-4 border border-gray-200">
                    {% else %}
                    <div class="w-16 h-16 bg-gray-100 rounded-md mr-4 flex items-center justify-center text-gray-400">No
                        Img</div>
                    {% endif %}
                    <div>
                        <h3 class="text-lg font-medium text-gray-900">{{ item.product.name }}</h3>
                        <p class="text-gray-500 text-sm">Qty: {{ item.quantity }}</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="font-medium text-gray-800">${{ item.price }}</p>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const orderId = "{{ order.id }}";
        const factoryCoords = [40.7128, -74.0060];
        const destCoords = [42.3601, -71.0589];

        // Map Init
        var map = L.map('tracking-map').setView(factoryCoords, 6);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        var factoryMarker = L.marker(factoryCoords).addTo(map).bindPopup('Distribution Center');
        var destMarker = L.marker(destCoords).addTo(map).bindPopup('Delivery Address');
        var truckIcon = L.divIcon({
            className: 'truck-icon',
            html: '<div style="background-color: #10b981; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.3);"></div>',
            iconSize: [16, 16]
        });

        let truckMarker = null;

        var latlngs = [factoryCoords, destCoords];
        var polyline = L.polyline(latlngs, { color: '#3b82f6', opacity: 0.5, dashArray: '10, 10' }).addTo(map);
        map.fitBounds(polyline.getBounds(), { padding: [50, 50] });

        function formatTime(isoString) {
            if (!isoString || isoString === 'None') return 'Pending';
            const date = new Date(isoString);
            return date.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
        }

        function updateUI(data) {
            // Update Timestamps
            const createdText = formatTime(document.getElementById('time-created').getAttribute('data-timestamp'));
            document.getElementById('time-created').textContent = createdText;

            const shippedEl = document.getElementById('time-shipped');
            shippedEl.textContent = formatTime(data.shipped_at);

            const deliveredEl = document.getElementById('time-delivered');
            deliveredEl.textContent = formatTime(data.delivered_at);

            // Update Progress Line
            const progressLine = document.getElementById('progress-line');
            if (data.status === 'Created') progressLine.style.width = '0%';
            else if (data.status === 'Shipped') progressLine.style.width = '50%';
            else if (data.status === 'Delivered') progressLine.style.width = '100%';

            // Update Icons
            const iconCheck = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';

            // Shipped Icon
            const shippedIcon = document.getElementById('step-shipped-icon');
            if (data.is_shipped) {
                shippedIcon.className = "w-8 h-8 rounded-full flex items-center justify-center border-2 transition-colors duration-500 bg-green-500 border-green-500 text-white";
                shippedIcon.innerHTML = iconCheck;
            }

            // Delivered Icon
            const deliveredIcon = document.getElementById('step-delivered-icon');
            if (data.is_delivered) {
                deliveredIcon.className = "w-8 h-8 rounded-full flex items-center justify-center border-2 transition-colors duration-500 bg-green-500 border-green-500 text-white";
                deliveredIcon.innerHTML = iconCheck;
            }

            // Update Map
            let currentCoords = factoryCoords;
            if (data.status === 'Shipped') {
                currentCoords = [(factoryCoords[0] + destCoords[0]) / 2, (factoryCoords[1] + destCoords[1]) / 2];
            } else if (data.status === 'Delivered') {
                currentCoords = destCoords;
            }

            if (data.status !== 'Created') {
                if (truckMarker) {
                    truckMarker.setLatLng(currentCoords);
                } else {
                    truckMarker = L.marker(currentCoords, { icon: truckIcon }).addTo(map).bindPopup('On the way!');
                }
                if (data.status === 'Delivered') truckMarker.bindPopup('Delivered!');
            }
        }

        // Poll API
        async function fetchStatus() {
            try {
                const response = await fetch(`/api/order/${orderId}/status/`);
                const data = await response.json();
                updateUI(data);
            } catch (e) {
                console.error("Error polling status:", e);
            }
        }

        // Initial Load
        // We call updateUI with initial template data first to avoid flicker? 
        // Or just fetch immediately. Let's fetch immediately.
        // Actually, populate initial UI from template first.
        const initialData = {
            status: "{{ order.status }}",
            shipped_at: "{{ order.shipped_at|date:'c' }}",
            delivered_at: "{{ order.delivered_at|date:'c' }}",
            is_shipped: {% if order.shipped_at %}true{% else %} false{% endif %},
        is_delivered: {% if order.delivered_at %} true{% else %} false{% endif %}
    };
    updateUI(initialData);

    // Start Polling
    if (initialData.status !== 'Delivered') {
        setInterval(fetchStatus, 3000);
    }
    });
</script>
{% endblock %}