{% extends 'base.html' %}
{% load static %}

{% block title %}Home - Keanu's Candy Store{% endblock %}

{% block header_search %}
<div class="search-container">
    <input type="text" id="candySearch" class="search-input" placeholder="Search for candies, chocolates, etc..."
        list="candyList">
    <button type="button" class="search-button" onclick="document.getElementById('candySearch').focus()">Search</button>
    <datalist id="candyList">
        <!-- Populated by JS in home.html -->
    </datalist>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .video-hero {
        position: relative;
        width: 100vw;
        height: 60vh;
        min-height: 400px;
        margin-left: -50vw;
        left: 50%;
        overflow: hidden;
        margin-bottom: 2rem;
        margin-top: -2rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        z-index: 1;
    }

    .hero-video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: 1;
    }

    .video-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        z-index: 2;
    }

    .hero-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 3;
        text-align: center;
        width: 100%;
        padding: 0 1rem;
    }

    .hero-content h2 {
        font-size: 3.5rem;
        font-weight: 800;
        text-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
        color: white;
        margin: 0;
        letter-spacing: -0.025em;
    }

      .page-subtitle {
            font-size: 1.3rem;
        }

    @media (max-width: 768px) {
        .hero-content h2 {
            font-size: 2rem;
        }
    }

    /* Glossy Add to Cart Button */
    .glossy-btn {
        background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
        color: white;
        border: none;
        padding: 0.5rem 1.25rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4),
            inset 0 -2px 5px rgba(0, 0, 0, 0.2),
            inset 0 2px 5px rgba(255, 255, 255, 0.3);
        position: relative;
        overflow: hidden;
        flex: 1;
    }

    .glossy-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s;
    }

    .glossy-btn:hover::before {
        left: 100%;
    }

    .glossy-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(37, 99, 235, 0.5),
            inset 0 -2px 5px rgba(0, 0, 0, 0.2),
            inset 0 2px 5px rgba(255, 255, 255, 0.3);
    }

    .glossy-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 10px rgba(37, 99, 235, 0.3),
            inset 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    /* 3-Dot Menu Button */
    .dots-menu {
        background: #f3f4f6;
        border: none;
        padding: 0.5rem 0.4rem;
        border-radius: 8px;
        cursor: pointer;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 40px;
        text-decoration: none;
    }

    .dots-menu::before {
        content: 'â‹¯';
        font-size: 1.2rem;
        color: #374151;
        font-weight: bold;
    }

    /* Tooltip */
    .dots-menu[title]:hover::after {
        content: attr(title);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #1f2937;
        color: white;
        padding: 0.4rem 0.8rem;
        border-radius: 6px;
        font-size: 0.75rem;
        white-space: nowrap;
        margin-bottom: 8px;
        z-index: 10;
    }

    .dots-menu[title]:hover::before {
        content: '';
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 5px solid transparent;
        border-top-color: #1f2937;
        margin-bottom: 3px;
    }

    /* Mobile Responsiveness for Home Page */
    @media (max-width: 768px) {
        .video-hero {
            height: 40vh;
            min-height: 300px;
            margin-top: -1rem;
            margin-bottom: 0;
        }

        .hero-content h2 {
            font-size: 2rem !important;
        }

        .page-subtitle {
            font-size: 1rem;
            padding: 0 1rem;
            margin-top: 1rem;
        }

        .glossy-btn {
            font-size: 0.85rem;
            padding: 0.5rem 1rem;
        }

        .dots-menu {
            min-width: 35px;
            padding: 0.5rem 0.3rem;
        }

        .dots-menu::before {
            font-size: 1rem;
        }
    }

    @media (max-width: 480px) {
        .video-hero {
            height: 30vh;
            min-height: 250px;
        }

        .hero-content h2 {
            font-size: 1.5rem !important;
        }

        .glossy-btn {
            font-size: 0.8rem;
            padding: 0.45rem 0.9rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div id="candy-wrapper">
    <div class="wrapper-half wrapper-left"></div>
    <div class="wrapper-half wrapper-right"></div>
</div>

<div class="video-hero">
    <video autoplay muted loop playsinline class="hero-video">
        <source src="{% static 'store/images/KCSVideo.mp4' %}" type="video/mp4">
        Your browser does not support the video tag.
    </video>
    <div class="video-overlay"></div>
    <div class="hero-content">
        <h2>Welcome to Keanu's Candy Store!</h2>
    </div>
</div>

<p class="page-subtitle" id="candy-section">Browse our delicious selection of candies below.</p>

<div class="candy-grid">
    {% for candy in candies %}
    <div class="candy-card">

        {% if candy.name == "Caramel" %}
        <img src="{% static 'store/images/caramel.png' %}" alt="Caramel" class="candy-image">
        {% elif candy.name == "Chocolate Bar" %}
        <img src="{% static 'store/images/Chocolate_Bar.png' %}" alt="Chocolate Bar" class="candy-image">
        {% elif candy.name == "Dark Chocolate" %}
        <img src="{% static 'store/images/Dark_Chocolate.png' %}" alt="Dark Chocolate" class="candy-image">
        {% elif candy.name == "Gummy Bears" %}
        <img src="{% static 'store/images/Gummy_Bears.webp' %}" alt="Gummy Bears" class="candy-image">
        {% elif candy.name == "Jelly Beans" %}
        <img src="{% static 'store/images/Jelly_Beans.jpg' %}" alt="Jelly Beans" class="candy-image">
        {% elif candy.name == "Lollipop" %}
        <img src="{% static 'store/images/Lollipop.png' %}" alt="Lollipop" class="candy-image">
        {% elif candy.name == "Peppermint" %}
        <img src="{% static 'store/images/Peppermint.webp' %}" alt="Peppermint" class="candy-image">
        {% elif candy.name == "Sour Patch Kids" %}
        <img src="{% static 'store/images/SourPatch_kids.png' %}" alt="Sour Patch Kids" class="candy-image">
        {% endif %}

        <div class="card-content">
            <h3>{{ candy.name }}</h3>
            <p>{{ candy.description }}</p>
            <div class="price">${{ candy.price|floatformat:2 }}</div>
            <div class="stock">Stock: {{ candy.stock }}</div>

            <div class="card-actions">
                {% if candy.stock > 0 %}
                <form action="{% url 'cart_add' candy.id %}" method="post" class="add-to-cart-form">
                    {% csrf_token %}
                    <input type="hidden" name="quantity" value="1">
                    <button type="submit" class="glossy-btn">Add to Cart</button>
                </form>
                <a href="{% url 'candy_detail' candy.id %}" class="dots-menu" title="Details"></a>
                {% else %}
                <button class="btn btn-secondary" style="flex: 1; opacity: 0.6; cursor: not-allowed;" disabled>
                    Out of Stock
                </button>
                {% endif %}
            </div>
        </div>
    </div>
    {% empty %}
    <p>No candies available at the moment.</p>
    {% endfor %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Animation Logic
        const wrapper = document.getElementById('candy-wrapper');
        if (wrapper) {
            setTimeout(() => {
                wrapper.classList.add('wrapper-open');
            }, 500); // Small delay before opening

            setTimeout(() => {
                wrapper.style.display = 'none';
            }, 2000); // Wait for transition to finish
        }

        const searchInput = document.getElementById('candySearch');
        const candyList = document.getElementById('candyList');
        const candyCards = document.querySelectorAll('.candy-card');
        const candyGrid = document.querySelector('.candy-grid');

        // Populate datalist
        candyCards.forEach(card => {
            const name = card.querySelector('h3').textContent.trim();
            const option = document.createElement('option');
            option.value = name;
            candyList.appendChild(option);
        });

        // Search handler
        searchInput.addEventListener('input', function (e) {
            const searchTerm = e.target.value.toLowerCase().trim();

            // If empty, show all
            if (!searchTerm) {
                candyCards.forEach(card => card.style.display = 'flex');
                return;
            }

            let foundExactMatch = false;

            candyCards.forEach(card => {
                const name = card.querySelector('h3').textContent.trim().toLowerCase();

                // Show only if matches (filtering)
                if (name.includes(searchTerm)) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }

                // Check for exact match (from datalist selection)
                if (name === searchTerm) {
                    foundExactMatch = true;
                    // Scroll to it
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Highlight effect
                    card.style.transform = 'scale(1.05)';
                    card.style.boxShadow = '0 0 0 4px #2563eb';
                    setTimeout(() => {
                        card.style.transform = '';
                        card.style.boxShadow = '';
                    }, 2000);
                }
            });

            // If we selected a specific candy (autofill), hide others strictly
            const isSelectedFromList = Array.from(candyList.options).some(opt => opt.value.toLowerCase() === searchTerm);
            if (isSelectedFromList) {
                candyCards.forEach(card => {
                    const name = card.querySelector('h3').textContent.trim().toLowerCase();
                    if (name === searchTerm) {
                        card.style.display = 'flex';
                    } else {
                        card.style.display = 'none';
                    }
                });
            }
        });
    });
</script>
{% endblock %}